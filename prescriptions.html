<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Prescription Manager â€“ SMS</title>
  <link rel="icon" href="images/logo.png" type="image/x-icon"/>
  <!-- Add Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
  <!-- Add Font Awesome CDN for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    :root {
      --primary: #00adb5;
      --primary-dark: #00969e;
      --secondary: #393e46;
      --dark: #222831;
      --darker: #1e1e1e;
      --darkest: #121212;
      --light: #eeeeee;
      --danger: #ff2e63;
      --success: #00b894;
      --warning: #fdcb6e;
    }
    
    body { 
      background: var(--darkest); 
      color: var(--light); 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      margin:0; 
      line-height:1.6;
    }
    
    .header { 
      background: var(--darker); 
      padding:1em; 
      display:flex; 
      align-items:center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .header h1{ 
      flex:1; 
      color:var(--primary); 
      margin:0;
      font-size: 1.8rem;
    }
    
    .btn { 
      background: var(--primary); 
      color:var(--light); 
      border:none; 
      padding:0.6em 1.2em; 
      margin:0.5em; 
      border-radius:5px; 
      cursor:pointer; 
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .btn:hover{ 
      background: var(--primary-dark); 
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .btn-danger {
      background: var(--danger);
    }
    
    .btn-danger:hover {
      background: #e84363;
    }
    
    .container { 
      padding:2em; 
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .card { 
      background:var(--dark); 
      padding:1.5em; 
      border-radius:8px; 
      margin-bottom:1.5em; 
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .card h2{ 
      margin-top:0; 
      color:var(--primary); 
      border-bottom: 2px solid var(--secondary);
      padding-bottom: 0.5rem;
    }
    
    .card p{ margin:0.4em 0; }
    
    .badge { 
      display:inline-block; 
      padding:3px 8px; 
      background:var(--primary); 
      border-radius:4px; 
      font-size:0.9em; 
      font-weight: bold;
    }
    
    .badge-warning {
      background: var(--warning);
      color: #000;
    }
    
    .badge-danger {
      background: var(--danger);
    }
    
    .badge-success {
      background: var(--success);
    }
    
    .badge-secondary {
      background: var(--secondary);
    }

    /* Report Modal */
    .modal, .report-modal { 
      display:none; 
      position:fixed; 
      top:0; 
      left:0; 
      width:100%; 
      height:100%; 
      background:rgba(0,0,0,0.8); 
      z-index:1000; 
      overflow-y: auto;
    }
    
    .modal-content, .report-content { 
      background:var(--darker); 
      margin:5% auto; 
      padding:2em; 
      border-radius:8px; 
      width:90%; 
      max-width:800px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      animation: modalFadeIn 0.3s ease-out;
    }
    
    @keyframes modalFadeIn {
      from { opacity: 0; transform: translateY(-50px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .close{
      float:right; 
      font-size:1.5em; 
      cursor:pointer;
      color: var(--light);
      transition: color 0.2s;
    }
    
    .close:hover{
      color:var(--primary);
    }
    
    .modal-header { 
      display:flex; 
      justify-content:space-between; 
      align-items:center; 
      margin-bottom:1.5em; 
      padding-bottom: 0.5em;
      border-bottom: 1px solid var(--secondary);
    }
    
    .modal-header h3{ 
      margin:0; 
      color:var(--primary); 
      font-size: 1.5rem;
    }

    table{
      width:100%; 
      border-collapse:collapse; 
      margin:1.5em 0;
    }
    
    th,td{
      padding:0.8em; 
      border-bottom:1px solid var(--secondary); 
      text-align:left;
    }
    
    th{
      color:var(--primary);
      font-weight: 600;
      background: rgba(0, 173, 181, 0.1);
    }
    
    tr:hover {
      background: rgba(57, 62, 70, 0.5);
    }
    
    .prescription-item {
      background: rgba(57, 62, 70, 0.3);
      padding: 1em;
      border-radius: 6px;
      margin-bottom: 1em;
      transition: all 0.3s ease;
    }
    
    .prescription-item:hover {
      background: rgba(57, 62, 70, 0.5);
      transform: translateX(5px);
    }
    
    .time-badge {
      display: inline-flex;
      align-items: center;
      margin-right: 0.5em;
      margin-bottom: 0.5em;
    }
    
    .time-badge .time {
      padding: 3px 8px;
      background: var(--secondary);
      border-radius: 4px 0 0 4px;
      font-size: 0.8em;
    }
    
    .time-badge .status {
      padding: 3px 8px;
      border-radius: 0 4px 4px 0;
      font-size: 0.8em;
      font-weight: bold;
    }
    
    .status-taken {
      background: var(--success);
      color: white;
    }
    
    .status-missed {
      background: var(--danger);
      color: white;
    }
    
    .status-pending {
      background: var(--warning);
      color: #000;
    }
    
    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1em;
      margin: 1.5em 0;
    }
    
    .stat-card {
      background: var(--secondary);
      padding: 1em;
      border-radius: 8px;
      text-align: center;
    }
    
    .stat-card h4 {
      margin: 0 0 0.5em 0;
      color: var(--primary);
    }
    
    .stat-card .value {
      font-size: 1.8em;
      font-weight: bold;
    }
    
    .completed {
      opacity: 0.6;
      position: relative;
    }
    
    .completed::after {
      content: "COMPLETED";
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--success);
      color: white;
      padding: 0.3em 0.6em;
      border-radius: 4px;
      font-size: 0.8em;
      font-weight: bold;
    }
    
    .action-buttons {
      margin-top: 1em;
      display: flex;
      gap: 0.5em;
    }
    
    .action-btn {
      padding: 0.3em 0.6em;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8em;
      font-weight: bold;
    }
    
    .mark-taken {
      background: var(--success);
      color: white;
    }
    
    .mark-missed {
      background: var(--danger);
      color: white;
    }
    
    .form-group {
      margin-bottom: 1.5em;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 0.5em;
      color: var(--primary);
      font-weight: 600;
    }
    
    .form-group input, 
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 0.8em;
      border: 1px solid var(--secondary);
      border-radius: 4px;
      background: var(--dark);
      color: var(--light);
    }
    
    .form-group textarea {
      min-height: 100px;
      resize: vertical;
    }
    
    .time-checkboxes {
      display: flex;
      gap: 1em;
      margin-top: 0.5em;
    }
    
    .checkbox-container {
      display: flex;
      align-items: center;
    }
    
    .checkbox-container input {
      margin-right: 0.5em;
    }
    
    .tabs {
      display: flex;
      border-bottom: 1px solid var(--secondary);
      margin-bottom: 1.5em;
    }
    
    .tab {
      padding: 0.8em 1.5em;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      font-weight: 600;
    }
    
    .tab.active {
      border-bottom: 3px solid var(--primary);
      color: var(--primary);
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .empty-state {
      text-align: center;
      padding: 2em;
      color: var(--secondary);
    }
    
    .empty-state i {
      font-size: 3em;
      margin-bottom: 0.5em;
      display: block;
      color: var(--secondary);
    }
    
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--success);
      color: white;
      padding: 1em 2em;
      border-radius: 5px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.2);
      z-index: 1000;
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s ease;
    }
    
    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }
    
    .toast.error {
      background: var(--danger);
    }
    
    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .header h1 {
        margin-bottom: 1rem;
      }
      
      .stats-container {
        grid-template-columns: 1fr;
      }
    }

    /* navigation */

      .sidebar {
    width: 280px;
    background: linear-gradient(135deg, #1e1e2e 0%, #2d2d3a 100%);
    color: white;
    display: flex;
    flex-direction: column;
    position: fixed;
    height: 100vh;
    overflow: scroll;
    z-index: 1000;
    border-right: 1px solid #374151;
    box-shadow: 4px 0 20px rgba(0, 0, 0, 0.3);
}

.logo {
    /* padding: 2rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    background: rgba(16, 185, 129, 0.1); */
    position: sticky;
    top: 0;
    padding: 2rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    background: rgb(26, 70, 55);
    backdrop-filter: blur(10px);
    z-index: 1001;
}

.logo i {
    font-size: 2rem;
    color: #10b981;
    filter: drop-shadow(0 0 8px rgba(16, 185, 129, 0.5));
}

.logo span {
    font-size: 1.25rem;
    font-weight: 600;
    background: linear-gradient(135deg, #10b981, #34d399);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.nav-menu {
    flex: 1;
    padding: 1rem;
}

.nav-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    margin-bottom: 0.5rem;
    color: rgba(255, 255, 255, 0.8);
    text-decoration: none;
    border-radius: 0.75rem;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.nav-item::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(16, 185, 129, 0.1), transparent);
    transition: left 0.5s;
}

.nav-item:hover::before {
    left: 100%;
}

.nav-item:hover {
    background: rgba(16, 185, 129, 0.1);
    color: white;
    transform: translateX(8px);
    box-shadow: 0 4px 20px rgba(16, 185, 129, 0.2);
}

.nav-item.active {
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(52, 211, 153, 0.1));
    color: white;
    border-left: 3px solid #10b981;
}

.nav-item i {
    font-size: 1.25rem;
    width: 20px;
}

    /* /navigation */

  </style>
</head>

<!-- navigation -->

<div class="sidebar">
            <div class="logo">
                <img src="images/logo.png" width="50" height="50">
                <span>Sickbay MS</span>
            </div>
            <nav class="nav-menu">
                <a href="dashboard.html" class="nav-item"><i class="fas fa-house"></i><span>Dashboard</span></a>
                <a href="students.html" class="nav-item"><i class="fas fa-users"></i><span>Students</span></a>
                <a href="prescriptions.html" class="nav-item active"><i class="fas fa-prescription-bottle-alt"></i><span>Prescriptions</span></a>
                <a href="stocks.html" class="nav-item"><i class="fas fa-boxes"></i><span>Stock Management</span></a>
                <a href="analytics.html" class="nav-item"><i class="fas fa-chart-line"></i><span>Analytics</span></a>
                <a href="notes.html" class="nav-item"><i class="fas fa-sticky-note"></i><span>Notes</span></a>
                <a href="chat bot.html" class="nav-item"><i class="fas fa-robot"></i><span>The Med Bot</span></a>
                <a href="chat.html" class="nav-item"><i class="fas fa-envelope"></i><span>Chat-Room</span></a>
                <a href="Locater.html" class="nav-item"><i class="fas fa-map"></i><span>GPS</span></a>
                <a href="about.html" class="nav-item"><i class="fa-solid fa-address-card"></i><span>About Us</span></a>
                <a href="contact us.html" class="nav-item"><i class="fas fa-phone"></i><span>Contact Us</span></a>
                <a href="#" class="nav-item" onclick="logout()"><i class="fas fa-sign-out-alt"></i><span>Logout</span></a>
            </nav>
</div>

<!-- /navigation -->

<body>
  <div class="maincont">
  <div class="header">
    <h1> Prescription Manager</h1>
    <div>
      <button class="btn" onclick="simulateNewDay()" id="simulateBtn"> Simulate New Day</button>
      <button class="btn" onclick="openAddModal()"> Add Prescription</button>
    </div>
  </div>

  <div class="container">
    <div class="tabs">
      <div class="tab active" onclick="switchTab('active')">Active Prescriptions</div>
      <div class="tab" onclick="switchTab('completed')">Completed Treatments</div>
      <div class="tab" onclick="switchTab('all')">All Prescriptions</div>
    </div>
    
    <div id="activeTab" class="tab-content active">
      <div id="prescriptionsList" class="card">
        <h2> Active Prescriptions</h2>
        <div id="activePrescriptions"></div>
      </div>
    </div>
    
    <div id="completedTab" class="tab-content">
      <div class="card">
        <h2> Completed Treatments</h2>
        <div id="completedPrescriptions"></div>
      </div>
    </div>
    
    <div id="allTab" class="tab-content">
      <div class="card">
        <h2> All Prescriptions</h2>
        <div id="allPrescriptions"></div>
      </div>
    </div>
    
    <div id="reportSection" class="report-modal">
      <div class="report-content">
        <div class="modal-header">
          <h3> Daily Medication Report</h3>
          <span class="close" onclick="closeReport()">Ã—</span>
        </div>
        
        <div class="stats-container">
          <div class="stat-card">
            <h4>Completed Doses</h4>
            <div class="value" id="completedDoses">0</div>
          </div>
          <div class="stat-card">
            <h4>Missed Doses</h4>
            <div class="value" id="missedDoses">0</div>
          </div>
          <div class="stat-card">
            <h4>Pending Doses</h4>
            <div class="value" id="pendingDoses">0</div>
          </div>
          <div class="stat-card">
            <h4>Active Patients</h4>
            <div class="value" id="activePatients">0</div>
          </div>
          <div class="stat-card">
            <h4>Completed Treatments</h4>
            <div class="value" id="completedTreatments">0</div>
          </div>
        </div>
        
        <h3 style="color: var(--primary); margin-top: 1.5em;">Dosage Summary</h3>
        <table>
          <tr>
            <th>Time</th>
            <th>Completed</th>
            <th>Missed</th> 
            <th>Missed Patients</th>
          </tr>
          <tbody id="dosageSummary">
          </tbody>
        </table>
        
        <h3 style="color: var(--primary); margin-top: 1.5em;">Missed Doses Details</h3>
        <div id="missedDetails"></div>
        
        <h3 style="color: var(--primary); margin-top: 1.5em;">Completed Treatments</h3>
        <div id="completedDetails"></div>
        
        <div style="text-align: center; margin-top: 2em;">
          <button class="btn" onclick="closeReport()">Close Report</button>
        </div>
      </div>
    </div>

    <!-- Add Modal -->
    <div id="addModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>âž• Add New Prescription</h3>
          <span class="close" onclick="closeAddModal()">Ã—</span>
        </div>
        
        <form id="prescriptionForm" onsubmit="addPrescription(event)">
          <div class="form-group">
            <label for="patientName">Patient Name</label>
            <input type="text" id="patientName" required placeholder="Enter patient name">
          </div>
          
          <div class="form-group">
            <label for="medication">Medication</label>
            <input type="text" id="medication" required placeholder="Enter medication name">
          </div>
          
          <div class="form-group">
            <label for="days">Duration (days)</label>
            <input type="number" id="days" min="1" required placeholder="Enter number of days">
          </div>
          
          <div class="form-group">
            <label>Dosage Times</label>
            <div class="time-checkboxes">
              <div class="checkbox-container">
                <input type="checkbox" id="morning" value="morning">
                <label for="morning">Morning</label>
              </div>
              <div class="checkbox-container">
                <input type="checkbox" id="afternoon" value="afternoon">
                <label for="afternoon">Afternoon</label>
              </div>
              <div class="checkbox-container">
                <input type="checkbox" id="evening" value="evening">
                <label for="evening">Evening</label>
              </div>
            </div>
          </div>
          
          <div class="form-group">
            <label for="notes">Notes</label>
            <textarea id="notes" placeholder="Additional notes (optional)"></textarea>
          </div>
          
          <div style="text-align: right;">
            <button type="button" class="btn btn-danger" onclick="closeAddModal()">Cancel</button>
            <button type="submit" class="btn" id="addPrescriptionBtn">Add Prescription</button>
          </div>
        </form>
      </div>
    </div>

    <div class="card" style="margin-top:2em;">
      <h2> Notifications</h2>
      <div id="notificationsList">
        <div class="empty-state">
          <i>ðŸ“­</i>
          <p>No notifications yet</p>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:2em;">
      <h2> Set a Custom Notification</h2>
      <form id="scheduleForm">
        <label>
          Notification Title:
          <input type="text" id="reminderTitle" required>
        </label>
        <label>
          Notification Date:
          <input type="date" id="reminderDate" required>
        </label>
        <label>
          Notification Time:
          <input type="time" id="reminderTime" required>
        </label>
        <button type="submit" class="btn" style="margin-top:10px;">Schedule Notification</button>
        <button type="button" class="btn" id="simulateNotifBtn" style="margin-top:10px; margin-left:10px; background: var(--warning); color: #000;">
          Simulate Notification
        </button>
      </form>

      <h3 style="margin-top:2em;"> Scheduled Notifications</h3>
      <ul id="notificationList"></ul>

      <div id="liveNotifications" style="margin-top:30px;">
        <h3> Live Notifications</h3>
        <div id="liveList"></div>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="toast"></div>

  <script>
    // Initialize Firebase with your config
    const firebaseConfig = {
      apiKey: "AIzaSyBPbc82p3XWtzH0X4Ougj9MPeDiJF9vzYk",
      authDomain: "sms-db-7b1c7.firebaseapp.com",
      databaseURL: "https://sms-db-7b1c7-default-rtdb.firebaseio.com",
      projectId: "sms-db-7b1c7",
      storageBucket: "sms-db-7b1c7.appspot.com",
      messagingSenderId: "848657966289",
      appId: "1:848657966289:web:3d4ab0afabc6bc9b57d1f0",
      measurementId: "G-45LBM5CTZ0"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    
    // Reference to the prescriptions collection
    const prescriptionsRef = db.collection("prescriptions");
    const notificationsRef = db.collection("notifications");
    
    let prescriptions = [];
    let unsubscribePrescriptions = null;

    function generateId() {
      return db.collection("temp").doc().id;
    }

    // Load prescriptions from Firestore
    function loadPrescriptions() {
      unsubscribePrescriptions = prescriptionsRef.onSnapshot(snapshot => {
        prescriptions = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          prescriptions.push({
            id: doc.id,
            ...data,
            createdAt: data.createdAt?.toDate(),
            updatedAt: data.updatedAt?.toDate()
          });
        });
        renderPrescriptions();
      }, error => {
        console.error("Error loading prescriptions: ", error);
        showToast("Error loading prescriptions", "error");
      });
    }

    // Show toast notification
    function showToast(message, type = "success") {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = type === "error" ? "toast show error" : "toast show";
      
      setTimeout(() => {
        toast.className = "toast";
      }, 3000);
    }

    function renderPrescriptions() {
      const activeEl = document.getElementById("activePrescriptions");
      const completedEl = document.getElementById("completedPrescriptions");
      const allEl = document.getElementById("allPrescriptions");
      
      // Filter prescriptions
      const activePrescriptions = prescriptions.filter(p => !p.completed && p.daysLeft >= 0);
      const completedPrescriptions = prescriptions.filter(p => p.completed);
      
      // Render active prescriptions
      if (activePrescriptions.length) {
        activeEl.innerHTML = activePrescriptions.map(p => renderPrescriptionItem(p)).join("");
      } else {
        activeEl.innerHTML = `
          <div class="empty-state">
            <i></i>
            <p>No active prescriptions found</p>
          </div>
        `;
      }
      
      // Render completed prescriptions
      if (completedPrescriptions.length) {
        completedEl.innerHTML = completedPrescriptions.map(p => renderPrescriptionItem(p, true)).join("");
      } else {
        completedEl.innerHTML = `
          <div class="empty-state">
            <i></i>
            <p>No completed treatments yet</p>
          </div>
        `;
      }
      
      // Render all prescriptions
      if (prescriptions.length) {
        allEl.innerHTML = prescriptions.map(p => renderPrescriptionItem(p, p.completed)).join("");
      } else {
        allEl.innerHTML = `
          <div class="empty-state">
            <i></i>
            <p>No prescriptions added yet</p>
          </div>
        `;
      }
    }
    
    function renderPrescriptionItem(p, isCompleted = false) {
      const completionPercentage = Math.round(((p.daysTotal - p.daysLeft) / p.daysTotal) * 100);
      
      return `
        <div class="prescription-item ${isCompleted ? 'completed' : ''}" data-id="${p.id}">
          <div style="display: flex; justify-content: space-between;">
            <div>
              <strong>${p.name}</strong> â€” ${p.medication} 
              <span class="badge ${isCompleted ? 'badge-success' : 'badge-warning'}">
                ${isCompleted ? 'Completed' : `${p.daysLeft}d left`}
              </span>
            </div>
            <div style="font-size: 0.9em;">
              Progress: ${completionPercentage}%
            </div>
          </div>
          <div style="margin-top: 0.5em;">
            ${p.dosageTimes.map(t => {
              const isTaken = p.takenToday?.includes(t) || false;
              const isMissed = !isTaken && p.daysLeft >= 0;
              const timeLabel = t.charAt(0).toUpperCase() + t.slice(1);

              return `
                <div class="time-badge">
                  <div class="time">${timeLabel}</div>
                  <div class="status ${
                    isTaken ? 'status-taken' : 
                    (isMissed ? 'status-missed' : 'status-pending')
                  }">
                    ${isTaken ? 'Taken' : (isMissed ? 'Missed' : 'Pending')}
                  </div>
                  ${!isCompleted ? `
                    <button 
                      class="action-btn mark-taken" 
                      style="margin-left:8px; padding:2px 8px; font-size:0.85em;"
                      onclick="markDose('${p.id}', 'taken', '${t}')"
                      ${isTaken ? 'disabled' : ''}>
                      Mark as Taken
                    </button>
                    <button 
                      class="action-btn mark-missed" 
                      style="margin-left:4px; padding:2px 8px; font-size:0.85em;"
                      onclick="markDose('${p.id}', 'missed', '${t}')"
                      ${!isTaken && isMissed ? 'disabled' : ''}>
                      Mark as Missed
                    </button>
                  ` : ''}
                </div>
              `;
            }).join("")}
          </div>
          ${p.notes ? `<div style="margin-top: 0.5em; font-size: 0.9em;"> ${p.notes}</div>` : ''}
          
          ${!isCompleted ? `
            <div class="action-buttons">
              <button class="action-btn mark-taken" onclick="markDose('${p.id}', 'taken')">Mark All as Taken</button>
              <button class="action-btn mark-missed" onclick="markDose('${p.id}', 'missed')">Mark All as Missed</button>
              <button class="action-btn" onclick="deletePrescription('${p.id}')" style="background: var(--danger); color: white;">Delete</button>
            </div>
          ` : ''}
        </div>
      `;
    }
    
    async function markDose(id, status, time) {
      try {
        const prescription = prescriptions.find(p => p.id === id);
        if (!prescription) return;
        
        let updateData = {};
        
        if (status === 'taken') {
          updateData.takenToday = [...prescription.takenToday, time];
        } else {
          updateData.takenToday = prescription.takenToday.filter(t => t !== time);
        }
        
        updateData.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
        
        await prescriptionsRef.doc(id).update(updateData);
        showToast(`Doses marked as ${status} successfully`);
      } catch (error) {
        console.error("Error updating prescription: ", error);
        showToast("Failed to update prescription", "error");
      }
    }
    
    async function deletePrescription(id) {
      if (confirm("Are you sure you want to delete this prescription?")) {
        try {
          await prescriptionsRef.doc(id).delete();
          showToast("Prescription deleted successfully");
        } catch (error) {
          console.error("Error deleting prescription: ", error);
          showToast("Failed to delete prescription", "error");
        }
      }
    }

    async function simulateNewDay() {
      if (!confirm('Advance all active prescriptions to the next day?')) {
        return;
      }

      try {
        const batch = db.batch();
        const now = firebase.firestore.FieldValue.serverTimestamp();
        let updatesCount = 0;

        for (const p of prescriptions) {
          if (!p.completed && p.daysLeft > 0) {
            const newDaysLeft = p.daysLeft - 1;
            batch.update(prescriptionsRef.doc(p.id), {
              daysLeft: newDaysLeft,
              completed: newDaysLeft <= 0,
              takenToday: [],
              updatedAt: now
            });
            updatesCount++;
          }
        }

        if (updatesCount === 0) {
          alert("No active prescriptions to update");
          return;
        }

        await batch.commit();
        alert(`Advanced ${updatesCount} prescriptions to next day`);
        
      } catch (error) {
        console.error("Simulation error:", error);
        alert("Failed to simulate new day");
      }
    }

    function showReport(r) {
      // Update stats cards
      document.getElementById('completedDoses').textContent = r.completedDoses;
      document.getElementById('missedDoses').textContent = r.missedDoses;
      document.getElementById('pendingDoses').textContent = r.pendingCount;
      document.getElementById('activePatients').textContent = r.activeCount;
      document.getElementById('completedTreatments').textContent = r.finishedTreatments;
      
      // Update dosage summary table
      document.getElementById('dosageSummary').innerHTML = `
        ${['morning', 'afternoon', 'evening'].map(t => `
          <tr>
            <td>${t.charAt(0).toUpperCase() + t.slice(1)}</td>
            <td>${r.completed[t]}</td>
            <td>${r.missed[t].length}</td>
            <td>${r.missed[t].join(', ') || '-'}</td>
          </tr>
        `).join('')}
      `;
      
      // Update missed details
      document.getElementById('missedDetails').innerHTML = `
        ${r.missed.morning.length + r.missed.afternoon.length + r.missed.evening.length > 0 ? `
          <table>
            <tr>
              <th>Patient</th>
              <th>Missed Times</th>
            </tr>
            ${getUniquePatients(r.missed).map(patient => `
              <tr>
                <td>${patient}</td>
                <td>
                  ${[
                    r.missed.morning.includes(patient) ? 'Morning' : null,
                    r.missed.afternoon.includes(patient) ? 'Afternoon' : null,
                    r.missed.evening.includes(patient) ? 'Evening' : null
                  ].filter(Boolean).join(', ')}
                </td>
              </tr>
            `).join('')}
          </table>
        ` : `
          <p>No missed doses today! </p>
        `}
      `;
      
      // Update completed treatments
      document.getElementById('completedDetails').innerHTML = `
        ${r.completedPatients.length > 0 ? `
          <ul>
            ${r.completedPatients.map(patient => `
              <li><strong>${patient}</strong> has completed their treatment</li>
            `).join('')}
          </ul>
        ` : `
          <p>No treatments completed today.</p>
        `}
      `;
      
      // Show the modal
      document.getElementById("reportSection").style.display = "block";
    }
    
    function getUniquePatients(missedObj) {
      const allPatients = [...missedObj.morning, ...missedObj.afternoon, ...missedObj.evening];
      return [...new Set(allPatients)];
    }

    function closeReport() { 
      document.getElementById("reportSection").style.display = "none"; 
    }

    function openAddModal() { 
      document.getElementById("addModal").style.display = "block"; 
    }
    
    function closeAddModal() { 
      document.getElementById("addModal").style.display = "none"; 
      document.getElementById("prescriptionForm").reset();
    }
    
    async function addPrescription(e) {
      e.preventDefault();
      
      try {
        // Show loading state
        const addBtn = document.getElementById('addPrescriptionBtn');
        addBtn.innerHTML = 'Adding...';
        addBtn.disabled = true;
        
        const name = document.getElementById('patientName').value;
        const medication = document.getElementById('medication').value;
        const days = parseInt(document.getElementById('days').value);
        const notes = document.getElementById('notes').value;
        
        // Validate form
        if (!name || !medication || !days) {
          showToast('Please fill in all required fields', 'error');
          addBtn.innerHTML = 'Add Prescription';
          addBtn.disabled = false;
          return;
        }
        
        // Get selected dosage times
        const dosageTimes = [];
        if (document.getElementById('morning').checked) dosageTimes.push('morning');
        if (document.getElementById('afternoon').checked) dosageTimes.push('afternoon');
        if (document.getElementById('evening').checked) dosageTimes.push('evening');
        
        if (dosageTimes.length === 0) {
          showToast('Please select at least one dosage time', 'error');
          addBtn.innerHTML = 'Add Prescription';
          addBtn.disabled = false;
          return;
        }
        
        const now = firebase.firestore.FieldValue.serverTimestamp();
        
        const newPrescription = {
          name,
          medication,
          dosageTimes,
          daysLeft: days,
          daysTotal: days,
          takenToday: [],
          history: [],
          completed: false,
          notes,
          createdAt: now,
          updatedAt: now
        };
        
        // Add to Firestore
        await prescriptionsRef.add(newPrescription);
        
        // Show success and reset form
        showToast('Prescription added successfully');
        document.getElementById('prescriptionForm').reset();
        closeAddModal();
        
      } catch (error) {
        console.error("Error adding prescription: ", error);
        showToast("Failed to add prescription", "error");
      } finally {
        // Reset button state
        const addBtn = document.getElementById('addPrescriptionBtn');
        if (addBtn) {
          addBtn.innerHTML = 'Add Prescription';
          addBtn.disabled = false;
        }
      }
    }
    
    function switchTab(tabName) {
      // Update tabs
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
      
      // Update content
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(`${tabName}Tab`).classList.add('active');
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadPrescriptions();
    });
    
    // Clean up Firestore listener when page unloads
    window.addEventListener('beforeunload', () => {
      if (unsubscribePrescriptions) {
        unsubscribePrescriptions();
      }
    });

    // Notifications feature
    function renderNotifications(notifications) {
      const list = document.getElementById('notificationsList');
      if (!notifications.length) {
        list.innerHTML = `
          <div class="empty-state">
            <i></i>
            <p>No notifications yet</p>
          </div>
        `;
        return;
      }
      list.innerHTML = notifications.map(n => `
        <div style="padding:1em; border-bottom:1px solid var(--secondary);">
          <div style="font-weight:600; color:var(--primary);">${n.title || 'Notification'}</div>
          <div style="margin:0.5em 0;">${n.message}</div>
          <div style="font-size:0.85em; color:var(--secondary);">
            ${n.createdAt ? new Date(n.createdAt.seconds * 1000).toLocaleString() : ''}
          </div>
        </div>
      `).join('');
    }

    // Load notifications from Firestore
    function loadNotifications() {
      notificationsRef.orderBy('createdAt', 'desc').limit(10).onSnapshot(snapshot => {
        const notifications = [];
        snapshot.forEach(doc => {
          notifications.push(doc.data());
        });
        renderNotifications(notifications);
      }, error => {
        console.error("Error loading notifications: ", error);
        renderNotifications([]);
      });
    }

    // Call loadNotifications on page load
    document.addEventListener('DOMContentLoaded', () => {
      loadNotifications();
    });

    let scheduledNotifications = [];

    // Load saved notifications
    if (localStorage.getItem("scheduledNotifs")) {
      scheduledNotifications = JSON.parse(localStorage.getItem("scheduledNotifs"));
    }

    const listEl = document.getElementById("notificationList");

    function renderScheduledList() {
      listEl.innerHTML = "";
      scheduledNotifications.forEach(n => {
        const li = document.createElement("li");
        li.textContent = `${n.title} â€” ${new Date(n.dateTime).toLocaleString()}`;
        listEl.appendChild(li);
      });
    }

    renderScheduledList();

    // Display a message on the page
    function showOnPageNotification(title, timeText) {
      const liveList = document.getElementById("liveList");
      const alertBox = document.createElement("div");
      alertBox.style.backgroundColor = "#ffeeba";
      alertBox.style.border = "1px solid #f0ad4e";
      alertBox.style.padding = "10px";
      alertBox.style.marginTop = "10px";
      alertBox.style.borderRadius = "5px";
      alertBox.innerHTML = `<strong>${title}</strong><br><small>${timeText}</small>`;
      liveList.appendChild(alertBox);
    }

    // Request permission on load
    if (Notification.permission !== "granted") {
      Notification.requestPermission();
    }

    document.getElementById("scheduleForm").addEventListener("submit", function (e) {
      e.preventDefault();
      const title = document.getElementById("reminderTitle").value;
      const date = document.getElementById("reminderDate").value;
      const time = document.getElementById("reminderTime").value;

      const dateTime = new Date(`${date}T${time}`);

      if (dateTime < new Date()) {
        alert("Please pick a future date/time.");
        return;
      }

      scheduledNotifications.push({ title, dateTime: dateTime.toISOString() });
      localStorage.setItem("scheduledNotifs", JSON.stringify(scheduledNotifications));
      renderScheduledList();
      alert("Notification scheduled!");
      document.getElementById("scheduleForm").reset();
    });

    // Check every minute for matching time
    setInterval(() => {
      const now = new Date();
      scheduledNotifications = scheduledNotifications.filter(n => {
        const target = new Date(n.dateTime);
        const isNow =
          now.getFullYear() === target.getFullYear() &&
          now.getMonth() === target.getMonth() &&
          now.getDate() === target.getDate() &&
          now.getHours() === target.getHours() &&
          now.getMinutes() === target.getMinutes();

        if (isNow) {
          // Show browser notification if allowed
          if (Notification.permission === "granted") {
            new Notification(` ${n.title}`, {
              body: `Scheduled for ${target.toLocaleTimeString()}`,
              icon: 'https://cdn-icons-png.flaticon.com/512/1827/1827392.png'
            });
          }

          // Show on-page notification
          showOnPageNotification(n.title, `Triggered at ${now.toLocaleTimeString()}`);
          return false; // remove after showing
        }

        return true;
      });

      localStorage.setItem("scheduledNotifs", JSON.stringify(scheduledNotifications));
      renderScheduledList();
    }, 60 * 1000); // every minute

    // Simulate Notification Button
    document.getElementById("simulateNotifBtn").addEventListener("click", function () {
      const title = document.getElementById("reminderTitle").value || "Test Notification";
      const now = new Date();
      // Show browser notification if allowed
      if (Notification.permission === "granted") {
        new Notification(` ${title}`, {
          body: `Simulated at ${now.toLocaleTimeString()}`,
          icon: 'https://cdn-icons-png.flaticon.com/512/1827/1827392.png'
        });
      }
      // Show on-page notification
      showOnPageNotification(title, `Simulated at ${now.toLocaleTimeString()}`);
    });
  </script>
  </div>
  <style>
    .maincont {
      margin-left: 280px; /* Adjust for sidebar width */
      padding: 2rem;
      background: var(--dark);
      min-height: 100vh;
    }
  </style>
</div>
</body>
</html>
